# =============================================================================
# AI Trading Platform - Docker Compose ì„¤ì • ì˜ˆì‹œ
# =============================================================================
# í•˜ë‚˜ì˜ ì´ë¯¸ì§€ë¡œ ë‘ ì„œë²„ë¥¼ ë™ì‹œì— ì‹¤í–‰í•˜ëŠ” ì˜ˆì‹œì…ë‹ˆë‹¤.
# 
# ì‚¬ìš©ë²•:
# 1. ì´ íŒŒì¼ì„ docker-compose.ymlë¡œ ë³µì‚¬
# 2. ì„¤ì • íŒŒì¼ ê²½ë¡œë¥¼ ì‹¤ì œ ê²½ë¡œë¡œ ìˆ˜ì •
# 3. docker-compose up -d ì‹¤í–‰

version: '3.8'

services:
  # ğŸŒ Base Web Server (ë©”ì¸ API ì„œë²„)
  web-server:
    image: ai-trading-platform:latest
    container_name: trading-web-server
    ports:
      - "8000:8000"                    # í˜¸ìŠ¤íŠ¸:ì»¨í…Œì´ë„ˆ í¬íŠ¸ ë§¤í•‘
    environment:
      - APP_ENV=PROD                   # ìš´ì˜ í™˜ê²½ ì„¤ì •
    volumes:
      # ì„¤ì • íŒŒì¼ì„ ì™¸ë¶€ì—ì„œ ë§ˆìš´íŠ¸ (ë³´ì•ˆìƒ ì½ê¸° ì „ìš©)
      - /opt/base-configs:/app/application/base_web_server:ro
      # ë¡œê·¸ íŒŒì¼ì„ í˜¸ìŠ¤íŠ¸ì— ì €ì¥ (ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ í›„ì—ë„ ë³´ì¡´)
      - /opt/logs/web-server:/app/logs
    restart: unless-stopped            # ì˜¤ë¥˜ ì‹œ ìë™ ì¬ì‹œì‘
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
    # ê¸°ë³¸ CMD ì‚¬ìš©: uvicorn application.base_web_server.main:app

  # ğŸ¤– Model Server (ML ì˜ˆì¸¡ ì„œë²„)  
  model-server:
    image: ai-trading-platform:latest  # ê°™ì€ ì´ë¯¸ì§€ ì‚¬ìš©!
    container_name: trading-model-server
    ports:
      - "8001:8001"                    # ë‹¤ë¥¸ í¬íŠ¸ë¡œ ë§¤í•‘
    environment:
      - APP_ENV=PROD                   # ìš´ì˜ í™˜ê²½ ì„¤ì •
    volumes:
      # Model Server ì „ìš© ì„¤ì • íŒŒì¼
      - /opt/model-configs:/app/application/model_server:ro
      # Model Server ì „ìš© ë¡œê·¸
      - /opt/logs/model-server:/app/logs
    restart: unless-stopped
    # CMD ì˜¤ë²„ë¼ì´ë“œë¡œ Model Server ì‹¤í–‰
    command: ["uvicorn", "application.model_server.main:app", "--host", "0.0.0.0", "--port", "8001"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/"]
      interval: 30s
      timeout: 10s
      retries: 3

# =============================================================================
# ğŸš€ ì‹¤í–‰ ë°©ë²•:
# =============================================================================
#
# 1ï¸âƒ£ ì„¤ì • íŒŒì¼ ì¤€ë¹„:
#    sudo mkdir -p /opt/base-configs /opt/model-configs /opt/logs
#    
#    # Base Web Server ì„¤ì • ë³µì‚¬
#    sudo cp base_web_server-config.json /opt/base-configs/
#    sudo cp base_web_server-config_debug.json /opt/base-configs/
#    
#    # Model Server ì„¤ì • ë³µì‚¬  
#    sudo cp model_server-config.json /opt/model-configs/
#
# 2ï¸âƒ£ ê¶Œí•œ ì„¤ì •:
#    sudo chmod 644 /opt/base-configs/*.json
#    sudo chmod 644 /opt/model-configs/*.json
#    sudo chmod 755 /opt/logs
#
# 3ï¸âƒ£ ì‹¤í–‰:
#    docker-compose up -d
#
# 4ï¸âƒ£ í™•ì¸:
#    curl http://localhost:8000/    # Base Web Server
#    curl http://localhost:8001/    # Model Server
#    docker-compose ps              # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
#    docker-compose logs -f         # ë¡œê·¸ í™•ì¸
#
# 5ï¸âƒ£ ê°œë³„ ì œì–´:
#    docker-compose up -d web-server     # Web Serverë§Œ ì‹¤í–‰
#    docker-compose up -d model-server   # Model Serverë§Œ ì‹¤í–‰
#    docker-compose stop web-server      # Web Serverë§Œ ì •ì§€
#    docker-compose restart model-server # Model Serverë§Œ ì¬ì‹œì‘
#
# 6ï¸âƒ£ ì „ì²´ ì •ë¦¬:
#    docker-compose down              # ëª¨ë“  ì»¨í…Œì´ë„ˆ ì •ì§€ ë° ì œê±°
#    docker-compose down -v          # ë³¼ë¥¨ë„ í•¨ê»˜ ì œê±°
# =============================================================================

# =============================================================================
# ğŸ”§ ê°œë°œ/ìŠ¤í…Œì´ì§• í™˜ê²½ ì˜ˆì‹œ:
# =============================================================================
# 
# ê°œë°œ í™˜ê²½ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •í•˜ì—¬ ì‚¬ìš©:
# 
# environment:
#   - APP_ENV=DEBUG                    # ë””ë²„ê·¸ ëª¨ë“œ
# 
# volumes:
#   - ./configs-dev:/app/application/base_web_server:ro  # ë¡œì»¬ ê°œë°œ ì„¤ì •
# 
# ports:
#   - "8000:8000"                     # ìš´ì˜ê³¼ ë™ì¼
#   - "8001:8001"                     # ìš´ì˜ê³¼ ë™ì¼
# =============================================================================