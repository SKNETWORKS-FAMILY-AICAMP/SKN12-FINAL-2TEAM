# =============================================================================
# AI Trading Platform - í•˜ë‚˜ì˜ ì´ë¯¸ì§€ë¡œ ë‘ ì„œë²„ ì§€ì›
# =============================================================================
# 
# ğŸ“¦ ì´ ì´ë¯¸ì§€ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•œ ì„œë²„:
# 1ï¸âƒ£ Base Web Server (ë©”ì¸ API) - í¬íŠ¸ 8000
# 2ï¸âƒ£ Model Server (ML ì˜ˆì¸¡) - í¬íŠ¸ 8001
#
# ğŸ¯ í•µì‹¬ ê°œë…:
# - í•˜ë‚˜ì˜ Docker ì´ë¯¸ì§€ì— ë‘ ì„œë²„ ì½”ë“œê°€ ëª¨ë‘ í¬í•¨ë¨
# - ì‹¤í–‰ ì‹œ CMDë¥¼ ë‹¤ë¥´ê²Œ ì§€ì •í•˜ì—¬ ì›í•˜ëŠ” ì„œë²„ ì„ íƒ
# - ê°ê° ë³„ë„ì˜ ì»¨í…Œì´ë„ˆë¡œ ì‹¤í–‰ë˜ì–´ ë…ë¦½ì ìœ¼ë¡œ ë™ì‘
# - ê°™ì€ ì½”ë“œë² ì´ìŠ¤ë¥¼ ê³µìœ í•˜ë¯€ë¡œ ì¼ê´€ì„± ìœ ì§€

FROM python:3.11-slim

# ê¸°ë³¸ í™˜ê²½ ì„¤ì •
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV TZ=Asia/Seoul

# í•„ìˆ˜ ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    curl \
    default-mysql-client \
    && rm -rf /var/lib/apt/lists/*

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# Python ì˜ì¡´ì„± ì„¤ì¹˜ (Docker ë ˆì´ì–´ ìºì‹± ìµœì í™”ë¥¼ ìœ„í•´ ë¨¼ì €)
COPY requirements.txt .
RUN pip install --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# ì „ì²´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
COPY . .

# Python path ì„¤ì •
ENV PYTHONPATH=/app:$PYTHONPATH

# ğŸ”’ ë³´ì•ˆ: .dockerignoreì—ì„œ ë¯¼ê°í•œ íŒŒì¼ë“¤ì„ ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì œì™¸
# - ì„¤ì • íŒŒì¼ (*.json): DB íŒ¨ìŠ¤ì›Œë“œ, API í‚¤ ë“± ë¯¼ê° ì •ë³´ 
# - ë¬¸ì„œ íŒŒì¼ (docs/, *.md): ì‹œìŠ¤í…œ êµ¬ì¡° ë…¸ì¶œ ë°©ì§€
# - ë¡œê·¸/ìºì‹œ íŒŒì¼: ë¶ˆí•„ìš”í•œ ë°ì´í„° ì œì™¸
# - ê°œë°œ/í…ŒìŠ¤íŠ¸ íŒŒì¼: ìš´ì˜ í™˜ê²½ì— ë¶ˆí•„ìš”í•œ íŒŒì¼ ì œì™¸

# í•„ìˆ˜ ë””ë ‰í† ë¦¬ ìƒì„±
RUN mkdir -p /app/logs

# í¬íŠ¸ ë…¸ì¶œ ì„ ì–¸ (ì‹¤ì œ ë°”ì¸ë”©ì€ docker run -p ì˜µì…˜ì—ì„œ)
EXPOSE 8000
EXPOSE 8001

# í—¬ìŠ¤ì²´í¬ ì„¤ì • (Base Web Server ê¸°ì¤€)
HEALTHCHECK --interval=30s --timeout=30s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:8000/ || exit 1

# ğŸš€ ê¸°ë³¸ ì‹¤í–‰ ëª…ë ¹ì–´ (Base Web Server)
# ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ë  ë•Œ ê¸°ë³¸ì ìœ¼ë¡œ ì‹¤í–‰ë  ëª…ë ¹ì–´
CMD ["python", "-m", "uvicorn", "application.base_web_server.main:app", "--host", "0.0.0.0", "--port", "8000"]

# =============================================================================
# ğŸš€ ì‚¬ìš©ë²• - í•˜ë‚˜ì˜ ì´ë¯¸ì§€ë¡œ ë‘ ì„œë²„ ì‹¤í–‰
# =============================================================================
#
# 1ï¸âƒ£ ì´ë¯¸ì§€ ë¹Œë“œ (í•œ ë²ˆë§Œ ì‹¤í–‰):
#    docker build -t ai-trading-platform .
#
# 2ï¸âƒ£ í˜¸ìŠ¤íŠ¸ì— ì„¤ì • íŒŒì¼ ì¤€ë¹„:
#    # Base Web Server ì„¤ì •
#    mkdir -p /opt/base-configs
#    # base_web_server-config.json, base_web_server-config_debug.json ë“±
#
#    # Model Server ì„¤ì •  
#    mkdir -p /opt/model-configs
#    # model_server-config.json ë“±
#
# 3ï¸âƒ£ Base Web Server ì‹¤í–‰:
#    docker run -d \
#      --name trading-web-server \
#      -p 8000:8000 \
#      -e APP_ENV=PROD \
#      -v /opt/base-configs:/app/application/base_web_server:ro \
#      ai-trading-platform
#    
#    # ê¸°ë³¸ CMDê°€ base_web_serverì´ë¯€ë¡œ ë³„ë„ ëª…ë ¹ì–´ ë¶ˆí•„ìš”
#
# 4ï¸âƒ£ Model Server ì‹¤í–‰ (ê°™ì€ ì´ë¯¸ì§€, ë‹¤ë¥¸ ëª…ë ¹ì–´):
#    docker run -d \
#      --name trading-model-server \
#      -p 8001:8001 \
#      -e APP_ENV=PROD \
#      -v /opt/model-configs:/app/application/model_server:ro \
#      ai-trading-platform \
#      uvicorn application.model_server.main:app --host 0.0.0.0 --port 8001
#    
#    # ë§ˆì§€ë§‰ ì¤„ì´ CMD ì˜¤ë²„ë¼ì´ë“œ (model_server ì‹¤í–‰ ëª…ë ¹ì–´)
#
# 5ï¸âƒ£ docker-composeë¡œ ë‘ ì„œë²„ í•¨ê»˜ ì‹¤í–‰:
#    version: '3.8'
#    services:
#      web-server:
#        image: ai-trading-platform
#        ports:
#          - "8000:8000"
#        environment:
#          - APP_ENV=PROD
#        volumes:
#          - /opt/base-configs:/app/application/base_web_server:ro
#        # ê¸°ë³¸ CMD ì‚¬ìš© (base_web_server)
#      
#      model-server:
#        image: ai-trading-platform  # ê°™ì€ ì´ë¯¸ì§€ ì‚¬ìš©!
#        ports:
#          - "8001:8001"
#        environment:
#          - APP_ENV=PROD
#        volumes:
#          - /opt/model-configs:/app/application/model_server:ro
#        command: ["uvicorn", "application.model_server.main:app", "--host", "0.0.0.0", "--port", "8001"]
#        # commandë¡œ CMD ì˜¤ë²„ë¼ì´ë“œ
#
# 6ï¸âƒ£ í™•ì¸:
#    curl http://localhost:8000/    # Base Web Server
#    curl http://localhost:8001/    # Model Server
#
# =============================================================================
# ğŸ’¡ í•µì‹¬ ê°œë… ì„¤ëª…:
# =============================================================================
# 
# ğŸ”¹ í•˜ë‚˜ì˜ ì´ë¯¸ì§€, ì—¬ëŸ¬ ì»¨í…Œì´ë„ˆ:
#   - Docker ì´ë¯¸ì§€ëŠ” 'í…œí”Œë¦¿' ê°œë…
#   - ê°™ì€ ì´ë¯¸ì§€ë¡œ ì—¬ëŸ¬ ì»¨í…Œì´ë„ˆ ìƒì„± ê°€ëŠ¥
#   - ê° ì»¨í…Œì´ë„ˆëŠ” ë…ë¦½ì ì¸ í”„ë¡œì„¸ìŠ¤
#
# ğŸ”¹ CMD ì˜¤ë²„ë¼ì´ë“œ:
#   - Dockerfileì˜ CMDëŠ” 'ê¸°ë³¸ê°’'
#   - docker run ë§ˆì§€ë§‰ì— ëª…ë ¹ì–´ë¥¼ ì£¼ë©´ CMD ëŒ€ì²´
#   - docker-composeì—ì„œëŠ” command: ì˜µì…˜ìœ¼ë¡œ ëŒ€ì²´
#
# ğŸ”¹ í¬íŠ¸ ë°”ì¸ë”©:
#   - ì»¨í…Œì´ë„ˆ ë‚´ë¶€ í¬íŠ¸ëŠ” ë…ë¦½ì 
#   - í˜¸ìŠ¤íŠ¸ í¬íŠ¸ë¡œ ë§¤í•‘: -p í˜¸ìŠ¤íŠ¸í¬íŠ¸:ì»¨í…Œì´ë„ˆí¬íŠ¸
#   - 8000:8000 (Base Web), 8001:8001 (Model)
#
# ğŸ”¹ ë³¼ë¥¨ ë§ˆìš´íŒ…:
#   - ê° ì„œë²„ëŠ” ë‹¤ë¥¸ ì„¤ì • íŒŒì¼ í•„ìš”
#   - ë‹¤ë¥¸ í˜¸ìŠ¤íŠ¸ ê²½ë¡œë¥¼ ê°ê° ë§ˆìš´íŠ¸
#   - /opt/base-configs â†’ base_web_server/
#   - /opt/model-configs â†’ model_server/
# =============================================================================