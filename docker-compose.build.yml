# =============================================================================
# AI Trading Platform - Docker Compose with Build Support
# =============================================================================
# 
# ğŸ¯ íŠ¹ì§•:
# - Docker ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ë©´ì„œ ì‹¤í–‰
# - Backend/Frontend ë¶„ë¦¬ ë°°í¬ ì§€ì›
# - ë¡œì»¬/ê°œë°œ/í”„ë¡œë•ì…˜ í™˜ê²½ ëª¨ë‘ ì§€ì›
# - ì„ íƒì  ì„œë¹„ìŠ¤ ì‹¤í–‰ ê°€ëŠ¥
#
# ğŸ“‹ ì‚¬ìš©ë²•:
# 1. ì „ì²´ ë¹Œë“œ: docker-compose -f docker-compose.build.yml up --build
# 2. Backendë§Œ: docker-compose -f docker-compose.build.yml up --build backend
# 3. Frontendë§Œ: docker-compose -f docker-compose.build.yml up --build frontend

version: '3.8'

services:
  # =============================================================================
  # Backend API Server (FastAPI)
  # =============================================================================
  backend:
    build:
      context: ./base_server
      dockerfile: Dockerfile
      args:
        - BUILD_DATE=${BUILD_DATE:-$(date -u +"%Y-%m-%dT%H:%M:%SZ")}
        - VCS_REF=${VCS_REF:-unknown}
        - BUILD_NUMBER=${BUILD_NUMBER:-local}
    image: ${DOCKER_IMAGE_BACKEND:-ashone91/trading-backend}:${TAG:-latest}
    container_name: trading-backend-build
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    environment:
      - APP_ENV=${APP_ENV:-LOCAL}
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=${LOG_LEVEL:-Debug}
      - TZ=Asia/Seoul
    volumes:
      # ì„¤ì • íŒŒì¼ (í™˜ê²½ë³„ë¡œ ë‹¤ë¥¸ ì„¤ì • ì‚¬ìš©)
      - ${CONFIG_PATH:-./base_server/application/base_web_server/base_web_server-config_local.json}:/app/application/base_web_server/base_web_server-config.json:ro
      - ${LOG_PATH:-./logs}:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - trading-network
    depends_on:
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy

  # =============================================================================
  # Frontend Server (Next.js)
  # =============================================================================
  frontend:
    build:
      context: ./base_server/frontend/ai-trading-platform
      dockerfile: Dockerfile
      args:
        - NODE_ENV=${NODE_ENV:-production}
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:8000}
        - NEXT_PUBLIC_WS_URL=${NEXT_PUBLIC_WS_URL:-ws://localhost:8000}
    image: ${DOCKER_IMAGE_FRONTEND:-ashone91/trading-frontend}:${TAG:-latest}
    container_name: trading-frontend-build
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://backend:8000}
      - NEXT_PUBLIC_WS_URL=${NEXT_PUBLIC_WS_URL:-ws://backend:8000}
      - NEXT_PUBLIC_API_TIMEOUT=${NEXT_PUBLIC_API_TIMEOUT:-10000}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    depends_on:
      - backend
    networks:
      - trading-network

  # =============================================================================
  # Model Server (ML/AI) - Optional
  # =============================================================================
  model-server:
    build:
      context: ./base_server
      dockerfile: Dockerfile
    image: ${DOCKER_IMAGE_BACKEND:-ashone91/trading-backend}:${TAG:-latest}
    container_name: trading-model-server-build
    ports:
      - "${MODEL_PORT:-8001}:8001"
    environment:
      - APP_ENV=${APP_ENV:-LOCAL}
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=${LOG_LEVEL:-Debug}
      - TZ=Asia/Seoul
    volumes:
      - ${MODEL_CONFIG_PATH:-./base_server/application/model_server}:/app/application/model_server:ro
      - ${LOG_PATH:-./logs}:/app/logs
    command: ["python", "-m", "uvicorn", "application.model_server.main:app", "--host", "0.0.0.0", "--port", "8001"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - trading-network
    profiles:
      - model # ì„ íƒì  ì‹¤í–‰ (--profile model ì˜µì…˜ í•„ìš”)

  # =============================================================================
  # Redis Cache Server
  # =============================================================================
  redis:
    image: redis:7-alpine
    container_name: trading-redis-build
    ports:
      - "${REDIS_PORT:-6379}:6379"
    command: >
      redis-server 
      --requirepass ${REDIS_PASSWORD:-dkdlqmsbwlstmdptmvkWkd1234!}
      --bind 0.0.0.0
      --port 6379
      --tcp-backlog 511
      --timeout 0
      --tcp-keepalive 300
      --daemonize no
      --supervised no
      --loglevel notice
      --databases 16
      --save 900 1
      --save 300 10
      --save 60 10000
      --rdbcompression yes
      --rdbchecksum yes
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-dkdlqmsbwlstmdptmvkWkd1234!}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - trading-network

  # =============================================================================
  # MySQL Database Server
  # =============================================================================
  mysql:
    image: mysql:8.0
    container_name: trading-mysql-build
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-dkdlqmsbwlstmdptmvkWkd1234!}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-finance_global}
      - MYSQL_USER=${MYSQL_USER:-trading}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-dkdlqmsbwlstmdptmvkWkd1234!}
      - TZ=Asia/Seoul
    volumes:
      - mysql-data:/var/lib/mysql
      - ${DB_SCRIPTS_PATH:-./base_server/db_scripts}:/docker-entrypoint-initdb.d:ro
    command: >
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --innodb-buffer-pool-size=256M
      --max-connections=200
      --bind-address=0.0.0.0
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-dkdlqmsbwlstmdptmvkWkd1234!}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - trading-network

# =============================================================================
# Networks & Volumes
# =============================================================================
networks:
  trading-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  redis-data:
    driver: local
  mysql-data:
    driver: local

# =============================================================================
# ğŸš€ ì‚¬ìš©ë²• ê°€ì´ë“œ
# =============================================================================
#
# 1ï¸âƒ£ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± (.env):
#    # Docker ì´ë¯¸ì§€ ì„¤ì •
#    DOCKER_IMAGE_BACKEND=ashone91/trading-backend
#    DOCKER_IMAGE_FRONTEND=ashone91/trading-frontend
#    TAG=latest
#    
#    # ì„œë¹„ìŠ¤ í¬íŠ¸
#    BACKEND_PORT=8000
#    FRONTEND_PORT=3000
#    MODEL_PORT=8001
#    REDIS_PORT=6379
#    MYSQL_PORT=3306
#    
#    # í™˜ê²½ ì„¤ì •
#    APP_ENV=LOCAL
#    NODE_ENV=production
#    LOG_LEVEL=Debug
#    
#    # API ì„¤ì •
#    NEXT_PUBLIC_API_URL=http://localhost:8000
#    NEXT_PUBLIC_WS_URL=ws://localhost:8000
#    
#    # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
#    MYSQL_ROOT_PASSWORD=dkdlqmsbwlstmdptmvkWkd1234!
#    MYSQL_DATABASE=finance_global
#    MYSQL_USER=trading
#    MYSQL_PASSWORD=dkdlqmsbwlstmdptmvkWkd1234!
#    REDIS_PASSWORD=dkdlqmsbwlstmdptmvkWkd1234!
#    
#    # íŒŒì¼ ê²½ë¡œ (í˜¸ìŠ¤íŠ¸ ê¸°ì¤€)
#    CONFIG_PATH=./base_server/application/base_web_server/base_web_server-config_local.json
#    LOG_PATH=./logs
#    DB_SCRIPTS_PATH=./base_server/db_scripts
#
# 2ï¸âƒ£ ì „ì²´ ìŠ¤íƒ ë¹Œë“œ ë° ì‹¤í–‰:
#    docker-compose -f docker-compose.build.yml up --build -d
#
# 3ï¸âƒ£ ê°œë³„ ì„œë¹„ìŠ¤ ë¹Œë“œ ë° ì‹¤í–‰:
#    # Backendë§Œ
#    docker-compose -f docker-compose.build.yml up --build backend mysql redis
#    
#    # Frontendë§Œ  
#    docker-compose -f docker-compose.build.yml up --build frontend
#    
#    # Model Server í¬í•¨
#    docker-compose -f docker-compose.build.yml --profile model up --build
#
# 4ï¸âƒ£ ë¶„ë¦¬ ë°°í¬ìš© (Backend ì„œë²„):
#    docker-compose -f docker-compose.build.yml up --build backend model-server mysql redis
#
# 5ï¸âƒ£ ë¶„ë¦¬ ë°°í¬ìš© (Frontend ì„œë²„):
#    # í™˜ê²½ ë³€ìˆ˜ì—ì„œ NEXT_PUBLIC_API_URLì„ Backend ì„œë²„ IPë¡œ ì„¤ì •
#    NEXT_PUBLIC_API_URL=http://backend-server-ip:8000
#    docker-compose -f docker-compose.build.yml up --build frontend
#
# 6ï¸âƒ£ ì´ë¯¸ì§€ë§Œ ë¹Œë“œ (ì‹¤í–‰í•˜ì§€ ì•ŠìŒ):
#    docker-compose -f docker-compose.build.yml build
#
# 7ï¸âƒ£ ë¹Œë“œëœ ì´ë¯¸ì§€ í™•ì¸:
#    docker images | grep trading
#
# 8ï¸âƒ£ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸:
#    docker-compose -f docker-compose.build.yml ps
#    docker-compose -f docker-compose.build.yml logs -f
#
# 9ï¸âƒ£ ì •ë¦¬:
#    docker-compose -f docker-compose.build.yml down
#    docker-compose -f docker-compose.build.yml down -v  # ë³¼ë¥¨ í¬í•¨
#
# ğŸ”Ÿ í”„ë¡œë•ì…˜ ë¹Œë“œ (ì´ë¯¸ì§€ í‘¸ì‹œ):
#    docker-compose -f docker-compose.build.yml build
#    docker-compose -f docker-compose.build.yml push
#
# =============================================================================
# ğŸ¯ ë°°í¬ ì‹œë‚˜ë¦¬ì˜¤ë³„ ì‚¬ìš©ë²•
# =============================================================================
#
# ğŸ“‹ ì‹œë‚˜ë¦¬ì˜¤ 1: ë¡œì»¬ ê°œë°œ (ëª¨ë“  ì„œë¹„ìŠ¤ ê°™ì€ ë¨¸ì‹ )
#    docker-compose -f docker-compose.build.yml up --build
#
# ğŸ“‹ ì‹œë‚˜ë¦¬ì˜¤ 2: Backend ì„œë²„ ë°°í¬ (DB í¬í•¨)
#    docker-compose -f docker-compose.build.yml up --build backend mysql redis
#
# ğŸ“‹ ì‹œë‚˜ë¦¬ì˜¤ 3: Frontend ì„œë²„ ë°°í¬ (BackendëŠ” ì™¸ë¶€)
#    # .envì—ì„œ NEXT_PUBLIC_API_URLì„ Backend ì„œë²„ IPë¡œ ë³€ê²½
#    docker-compose -f docker-compose.build.yml up --build frontend
#
# ğŸ“‹ ì‹œë‚˜ë¦¬ì˜¤ 4: AWS ELB + Auto Scaling ë°°í¬
#    # ê° EC2ì—ì„œ ê°œë³„ ì„œë¹„ìŠ¤ ì‹¤í–‰
#    # Backend EC2: backend + mysql + redis
#    # Frontend EC2: frontend
#
# ğŸ“‹ ì‹œë‚˜ë¦¬ì˜¤ 5: Jenkins CI/CD í†µí•©
#    # Jenkinsfileì—ì„œ ì´ compose íŒŒì¼ ì‚¬ìš©
#    # ë¹Œë“œ â†’ í‘¸ì‹œ â†’ ë°°í¬ ìë™í™”
#
# =============================================================================