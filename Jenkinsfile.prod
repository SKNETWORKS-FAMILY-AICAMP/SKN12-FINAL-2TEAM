pipeline {
    agent any
    
    triggers {
        githubPush()
    }
    
    environment {
        // Git ì„¤ì •
        GIT_REPO = 'https://github.com/SKNETWORKS-FAMILY-AICAMP/SKN12-FINAL-2TEAM.git'
        GIT_BRANCH = 'main'
        
        // Docker Hub ì„¤ì •
        DOCKER_HUB_REPO_BACKEND = 'ashone91/trading-backend'
        DOCKER_HUB_REPO_FRONTEND = 'ashone91/trading-frontend'
        DOCKER_CREDENTIALS_ID = 'dockerhub-creds'
        
        // AWS EC2 ë°°í¬ ì„¤ì •
        DEPLOY_HOST = 'ec2-xx-xxx-xxx-xxx.compute.amazonaws.com'
        DEPLOY_USER = 'ubuntu'
        SSH_CREDENTIALS_ID = 'deploy-server-ssh'
        
        // ë²„ì „ íƒœê·¸
        BUILD_TAG = "${env.BUILD_NUMBER}-${env.GIT_COMMIT?.take(7)}"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo "Checking out code from ${GIT_REPO}"
                git branch: "${GIT_BRANCH}", url: "${GIT_REPO}"
            }
        }
        
        stage('Build Backend Docker Image') {
            steps {
                dir('base_server') {
                    script {
                        echo "Building Backend Docker image..."
                        sh """
                            docker build -t ${DOCKER_HUB_REPO_BACKEND}:${BUILD_TAG} \
                                        -t ${DOCKER_HUB_REPO_BACKEND}:latest \
                                        -f Dockerfile .
                        """
                    }
                }
            }
        }
        
        stage('Build Frontend Docker Image') {
            steps {
                dir('base_server/frontend/ai-trading-platform') {
                    script {
                        echo "Building Frontend Docker image with production URLs..."
                        sh """
                            # Docker ìºì‹œ ë¬´íš¨í™”ë¥¼ ìœ„í•œ ê°•ì œ ë¦¬ë¹Œë“œ
                            docker build --no-cache \
                                        --build-arg NEXT_PUBLIC_API_URL=https://bullant-kr.com \
                                        --build-arg NEXT_PUBLIC_WS_URL=wss://bullant-kr.com \
                                        --build-arg NEXT_PUBLIC_API_TIMEOUT=10000 \
                                        -t ${DOCKER_HUB_REPO_FRONTEND}:${BUILD_TAG} \
                                        -t ${DOCKER_HUB_REPO_FRONTEND}:latest \
                                        -f Dockerfile .
                                        
                            echo "âœ… Build Args ì ìš©ë¨:"
                            echo "  NEXT_PUBLIC_API_URL=https://bullant-kr.com"
                            echo "  NEXT_PUBLIC_WS_URL=wss://bullant-kr.com"
                        """
                    }
                }
            }
        }
        
        stage('Push to Docker Hub') {
            steps {
                script {
                    withCredentials([usernamePassword(
                        credentialsId: "${DOCKER_CREDENTIALS_ID}",
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh """
                            echo "${DOCKER_PASS}" | docker login -u "${DOCKER_USER}" --password-stdin
                            
                            # Push Backend
                            docker push ${DOCKER_HUB_REPO_BACKEND}:${BUILD_TAG}
                            docker push ${DOCKER_HUB_REPO_BACKEND}:latest
                            
                            # Push Frontend
                            docker push ${DOCKER_HUB_REPO_FRONTEND}:${BUILD_TAG}
                            docker push ${DOCKER_HUB_REPO_FRONTEND}:latest
                            
                            docker logout
                        """
                    }
                }
            }
        }
        
        stage('Deploy to EC2') {
            parallel {
                stage('Deploy Backend') {
                    steps {
                        script {
                            sshagent(credentials: ["${SSH_CREDENTIALS_ID}"]) {
                                sh """
                                    ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} '
                                        # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
                                        cd /home/ubuntu/SKN12-FINAL-2TEAM
                                        git pull origin main
                                        
                                        # ìƒˆ Backend ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
                                        docker pull ${DOCKER_HUB_REPO_BACKEND}:${BUILD_TAG}
                                        docker pull ${DOCKER_HUB_REPO_BACKEND}:latest
                                        
                                        # ê¸°ì¡´ Backend Docker Compose ì¤‘ì§€
                                        docker-compose -f docker-compose.backend.yml down || true
                                        
                                        # Backend Docker Compose íŒŒì¼ ì—…ë°ì´íŠ¸
                                        tee docker-compose.backend.yml > /dev/null << \"COMPOSE_EOF\"
version: \"3.8\"

services:
  backend:
    image: ${DOCKER_HUB_REPO_BACKEND}:${BUILD_TAG}
    container_name: trading-backend-prod
    restart: unless-stopped
    ports:
      - \"8000:8000\"
    environment:
      - APP_ENV=PROD
      - PYTHONUNBUFFERED=1
    volumes:
      - \"/opt/trading/configs/base_web_server-config.json:/app/application/base_web_server/base_web_server-config.json:ro\"
      - \"/opt/trading/logs:/app/logs\"
    healthcheck:
      test: [\"CMD\", \"curl\", \"-f\", \"http://localhost:8000/health\"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - trading-backend-network

networks:
  trading-backend-network:
    driver: bridge
COMPOSE_EOF
                                        
                                        # ìƒˆ Backend ì„œë¹„ìŠ¤ ì‹œìž‘
                                        docker-compose -f docker-compose.backend.yml up -d
                                    '
                                """
                            }
                        }
                    }
                }
                stage('Deploy Frontend') {
                    steps {
                        script {
                            sshagent(credentials: ["${SSH_CREDENTIALS_ID}"]) {
                                sh """
                                    # Frontend ì„œë²„ê°€ ë‹¤ë¥¸ ê²½ìš°ë¥¼ ìœ„í•œ ë°°í¬
                                    # Frontend ì„œë²„ IPê°€ ë‹¤ë¥´ë©´ FRONTEND_DEPLOY_HOST í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©
                                    FRONTEND_HOST=\${FRONTEND_DEPLOY_HOST:-$DEPLOY_HOST}
                                    
                                    ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@\${FRONTEND_HOST} '
                                        # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸° (Frontend ì„œë²„ë„ ë™ì¼ ì €ìž¥ì†Œ ì‚¬ìš©)
                                        cd /home/ubuntu/SKN12-FINAL-2TEAM
                                        git pull origin main
                                        
                                        # ìƒˆ Frontend ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
                                        docker pull ${DOCKER_HUB_REPO_FRONTEND}:${BUILD_TAG}
                                        docker pull ${DOCKER_HUB_REPO_FRONTEND}:latest
                                        
                                        # ê¸°ì¡´ Frontend Docker Compose ì¤‘ì§€
                                        docker-compose -f docker-compose.frontend.yml down || true
                                        
                                        # Frontend Docker Compose íŒŒì¼ ì—…ë°ì´íŠ¸
                                        tee docker-compose.frontend.yml > /dev/null << \"COMPOSE_EOF\"
version: \"3.8\"

services:
  frontend:
    image: ${DOCKER_HUB_REPO_FRONTEND}:${BUILD_TAG}
    container_name: trading-frontend-prod
    restart: unless-stopped
    ports:
      - \"3000:3000\"
    environment:
      - NODE_ENV=production
    volumes:
      - \"/opt/trading/frontend-config/.env:/app/.env:ro\"
    healthcheck:
      test: [\"CMD\", \"wget\", \"--no-verbose\", \"--tries=1\", \"--spider\", \"http://localhost:3000\"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - trading-frontend-network

networks:
  trading-frontend-network:
    driver: bridge
COMPOSE_EOF
                                        
                                        # ìƒˆ Frontend ì„œë¹„ìŠ¤ ì‹œìž‘
                                        docker-compose -f docker-compose.frontend.yml up -d
                                    '
                                """
                            }
                        }
                    }
                }
            }
        }
        
        stage('Health Check') {
            steps {
                script {
                    sh """
                        sleep 30
                        
                        # Backend í—¬ìŠ¤ì²´í¬
                        curl -f http://${DEPLOY_HOST}:8000/health || exit 1
                        echo "âœ… Backend health check passed"
                        
                        # Frontend í—¬ìŠ¤ì²´í¬ (ë‹¤ë¥¸ ì„œë²„ì¼ ìˆ˜ ìžˆìŒ)
                        FRONTEND_HOST=\${FRONTEND_DEPLOY_HOST:-$DEPLOY_HOST}
                        curl -f http://\${FRONTEND_HOST}:3000 || exit 1
                        echo "âœ… Frontend health check passed"
                        
                        # Docker Compose ìƒíƒœ í™•ì¸
                        ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} '
                            echo "=== Backend Container Status ==="
                            docker-compose -f docker-compose.backend.yml ps
                            echo "=== Backend Logs (last 10 lines) ==="
                            docker-compose -f docker-compose.backend.yml logs --tail=10 backend
                        '
                        
                        FRONTEND_HOST=\${FRONTEND_DEPLOY_HOST:-$DEPLOY_HOST}
                        ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@\${FRONTEND_HOST} '
                            echo "=== Frontend Container Status ==="
                            docker-compose -f docker-compose.frontend.yml ps
                            echo "=== Frontend Logs (last 10 lines) ==="
                            docker-compose -f docker-compose.frontend.yml logs --tail=10 frontend
                        '
                        
                        echo "ðŸš€ All services are healthy and running!"
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo """
                âœ… Deployment Successful!
                - Backend: ${DOCKER_HUB_REPO_BACKEND}:${BUILD_TAG}
                - Frontend: ${DOCKER_HUB_REPO_FRONTEND}:${BUILD_TAG}
                - Server: ${DEPLOY_HOST}
            """
        }
        failure {
            echo "âŒ Deployment Failed! Check the logs for details."
        }
        cleanup {
            // ë¡œì»¬ ì´ë¯¸ì§€ ì •ë¦¬
            sh """
                docker image prune -f
                docker container prune -f
            """
        }
    }
}

// =============================================================================
// ðŸ”§ Jenkins ì„¤ì • í•„ìš”ì‚¬í•­
// =============================================================================
// 
// 1. Credentials ì„¤ì •:
//    - dockerhub-creds: Docker Hub ë¡œê·¸ì¸ (Username with password)
//    - deploy-server-ssh: EC2 SSH í‚¤ (SSH Username with private key)
//
// 2. í”ŒëŸ¬ê·¸ì¸ í•„ìš”:
//    - GitHub plugin
//    - Docker Pipeline
//    - SSH Agent plugin
//
// 3. Jenkins ì„œë²„ ìš”êµ¬ì‚¬í•­:
//    - Docker ì„¤ì¹˜
//    - Git ì„¤ì¹˜
//    - curl ì„¤ì¹˜
//
// 4. EC2 ë°°í¬ ì„œë²„ ì¤€ë¹„:
//    - Docker & Docker Compose ì„¤ì¹˜
//    - /home/ubuntu/SKN12-FINAL-2TEAM ê²½ë¡œì— ì €ìž¥ì†Œ í´ë¡ 
//    - /opt/trading/configs/base_web_server-config.json ì„¤ì • íŒŒì¼ ì¤€ë¹„
//
// 5. í™˜ê²½ ë³€ìˆ˜ ìˆ˜ì •:
//    - DEPLOY_HOST: ì‹¤ì œ EC2 í¼ë¸”ë¦­ DNS ë˜ëŠ” IP
//    - DOCKER_HUB_REPO_*: ì‹¤ì œ Docker Hub ì €ìž¥ì†Œëª…
//
// =============================================================================