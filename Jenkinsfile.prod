pipeline {
    agent any
    
    environment {
        // Docker Hub ì„¤ì •
        DOCKER_HUB_REPO_BACKEND = 'ashone91/trading-backend'
        DOCKER_HUB_REPO_FRONTEND = 'ashone91/trading-frontend'
        DOCKER_CREDENTIALS_ID = 'dockerhub-credentials'  // âš ï¸ ì‹¤ì œ Jenkins Credentials IDì™€ ì¼ì¹˜í•´ì•¼ í•¨
        
        // GitHub ì„¤ì •
        GIT_REPO = 'https://github.com/SKNETWORKS-FAMILY-AICAMP/SKN12-FINAL-2TEAM.git'
        GIT_BRANCH = 'main'
    }
    
    stages {
        stage('ğŸ” Checkout') {
            steps {
                echo "GitHub ì €ì¥ì†Œì—ì„œ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°..."
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${GIT_BRANCH}"]],
                    userRemoteConfigs: [[url: "${GIT_REPO}"]]
                ])
                
                script {
                    // ë¹Œë“œ íƒœê·¸ ìƒì„± (Git checkout í›„)
                    env.GIT_COMMIT_SHORT = sh(
                        script: 'git rev-parse HEAD | cut -c1-7',
                        returnStdout: true
                    ).trim()
                    env.BUILD_TAG = "${env.BUILD_NUMBER}-${env.GIT_COMMIT_SHORT}"
                    
                    // Git ì •ë³´ ì¶œë ¥
                    sh '''
                        echo "Branch: ${GIT_BRANCH}"
                        echo "Commit: $(git rev-parse HEAD)"
                        echo "Build Tag: ${BUILD_TAG}"
                        echo "Author: $(git log -1 --pretty=format:'%an')"
                        echo "Message: $(git log -1 --pretty=format:'%s')"
                    '''
                }
            }
        }
        
        stage('ğŸ”¨ Build Docker Images') {
            parallel {
                stage('Backend Build') {
                    steps {
                        echo "Backend Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘..."
                        dir('base_server') {
                            sh '''
                                docker build -t ${DOCKER_HUB_REPO_BACKEND}:${BUILD_TAG} \
                                            -t ${DOCKER_HUB_REPO_BACKEND}:latest \
                                            -f Dockerfile .
                                
                                echo "Backend ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ: ${DOCKER_HUB_REPO_BACKEND}:${BUILD_TAG}"
                            '''
                        }
                    }
                }
                
                stage('Frontend Build') {
                    steps {
                        echo "Frontend Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘..."
                        dir('base_server/frontend/ai-trading-platform') {
                            sh '''
                                # í”„ë¡œë•ì…˜ í™˜ê²½ë³€ìˆ˜ë¡œ Frontend ì´ë¯¸ì§€ ë¹Œë“œ (build-time ì£¼ì…)
                                docker build -t ${DOCKER_HUB_REPO_FRONTEND}:${BUILD_TAG} \
                                            -t ${DOCKER_HUB_REPO_FRONTEND}:latest \
                                            --build-arg NEXT_PUBLIC_API_URL=https://bullant-kr.com \
                                            --build-arg NEXT_PUBLIC_WS_URL=wss://bullant-kr.com \
                                            --build-arg NEXT_PUBLIC_API_TIMEOUT=10000 \
                                            -f Dockerfile .
                                            
                                echo "Frontend ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ: ${DOCKER_HUB_REPO_FRONTEND}:${BUILD_TAG}"
                                echo "âœ… í”„ë¡œë•ì…˜ í™˜ê²½ë³€ìˆ˜ build-time ì£¼ì… ì™„ë£Œ (https://bullant-kr.com)"
                            '''
                        }
                    }
                }
            }
        }
        
        stage('ğŸ“¤ Push to Docker Hub') {
            steps {
                echo "Docker Hubë¡œ ì´ë¯¸ì§€ í‘¸ì‹œ..."
                withCredentials([usernamePassword(
                    credentialsId: "${DOCKER_CREDENTIALS_ID}",
                    usernameVariable: 'DOCKER_USER',
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    sh '''
                        # Docker Hub ë¡œê·¸ì¸
                        echo "${DOCKER_PASS}" | docker login -u "${DOCKER_USER}" --password-stdin
                        
                        # Backend ì´ë¯¸ì§€ í‘¸ì‹œ
                        echo "Backend ì´ë¯¸ì§€ í‘¸ì‹œ ì¤‘..."
                        docker push ${DOCKER_HUB_REPO_BACKEND}:${BUILD_TAG}
                        docker push ${DOCKER_HUB_REPO_BACKEND}:latest
                        
                        # Frontend ì´ë¯¸ì§€ í‘¸ì‹œ
                        echo "Frontend ì´ë¯¸ì§€ í‘¸ì‹œ ì¤‘..."
                        docker push ${DOCKER_HUB_REPO_FRONTEND}:${BUILD_TAG}
                        docker push ${DOCKER_HUB_REPO_FRONTEND}:latest
                        
                        # ë¡œê·¸ì•„ì›ƒ
                        docker logout
                        
                        echo "âœ… Docker Hub í‘¸ì‹œ ì™„ë£Œ!"
                    '''
                }
            }
        }
        
        stage('ğŸš€ Deploy to Auto Scaling Groups') {
            steps {
                echo "Auto Scaling Group ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œ ê³ ì¹¨ ì‹œì‘..."
                
                script {
                    try {
                        // Backend Auto Scaling Group ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œ ê³ ì¹¨
                        echo "Backend Auto Scaling Group ë°°í¬ ì¤‘..."
                        sh '''
                            aws autoscaling start-instance-refresh \
                                --auto-scaling-group-name trading-backend-asg \
                                --preferences '{"MinHealthyPercentage":50,"InstanceWarmup":300}'
                        '''
                        
                        // Frontend Auto Scaling Group ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œ ê³ ì¹¨  
                        echo "Frontend Auto Scaling Group ë°°í¬ ì¤‘..."
                        sh '''
                            aws autoscaling start-instance-refresh \
                                --auto-scaling-group-name trading-frontend-asg \
                                --preferences '{"MinHealthyPercentage":50,"InstanceWarmup":300}'
                        '''
                        
                        echo """
                        ========================================
                        ğŸ‰ ë°°í¬ ì‹œì‘ë¨! 
                        ========================================
                        
                        ìƒˆë¡œìš´ Docker ì´ë¯¸ì§€ ë°°í¬:
                        - Backend: ${DOCKER_HUB_REPO_BACKEND}:${BUILD_TAG}
                        - Frontend: ${DOCKER_HUB_REPO_FRONTEND}:${BUILD_TAG}
                        
                        Auto Scaling Groupsê°€ ë¬´ì¤‘ë‹¨ìœ¼ë¡œ 
                        ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒˆë¡œ ê³ ì¹¨í•©ë‹ˆë‹¤ (ì•½ 5-10ë¶„ ì†Œìš”)
                        
                        ë°°í¬ ì§„í–‰ ìƒí™©:
                        AWS Console â†’ EC2 â†’ Auto Scaling Groups
                        â†’ Instance refresh íƒ­ì—ì„œ í™•ì¸
                        
                        ë°°í¬ ì™„ë£Œ í›„ í™•ì¸:
                        https://bullant-kr.com
                        
                        ========================================
                        """
                        
                    } catch (Exception e) {
                        echo "âš ï¸ Instance Refresh ì‹¤íŒ¨: ${e.getMessage()}"
                        echo "ìˆ˜ë™ìœ¼ë¡œ AWS Consoleì—ì„œ Instance Refresh ì‹¤í–‰í•˜ì„¸ìš”."
                        
                        // ì‹¤íŒ¨í•´ë„ ë¹Œë“œëŠ” ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬ (ì´ë¯¸ì§€ëŠ” í‘¸ì‹œë¨)
                        currentBuild.result = 'SUCCESS'
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo """
            âœ… âœ… âœ… íŒŒì´í”„ë¼ì¸ ì„±ê³µ! âœ… âœ… âœ…
            
            ë¹Œë“œ ë²ˆí˜¸: ${BUILD_NUMBER}
            ë¹Œë“œ íƒœê·¸: ${BUILD_TAG}
            
            Docker Hubì—ì„œ í™•ì¸:
            https://hub.docker.com/r/ashone91/trading-backend/tags
            https://hub.docker.com/r/ashone91/trading-frontend/tags
            """
        }
        
        failure {
            echo """
            âŒ âŒ âŒ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨! âŒ âŒ âŒ
            
            ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•˜ì„¸ìš”.
            Jenkins Blue Oceanì—ì„œ ìƒì„¸ ë¡œê·¸ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.
            """
        }
        
        always {
            script {
                try {
                    // ë””ìŠ¤í¬ ê³µê°„ í™•ë³´ë¥¼ ìœ„í•œ ì •ë¦¬
                    sh '''
                        echo "Docker ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
                        docker image prune -f || true
                        docker container prune -f || true
                        
                        # ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì‚­ì œ (3ì¼ ì´ìƒ)
                        docker image prune -a --filter "until=72h" -f || true
                        
                        echo "ì •ë¦¬ ì™„ë£Œ!"
                    '''
                } catch (Exception e) {
                    echo "ì •ë¦¬ ê³¼ì •ì—ì„œ ì˜¤ë¥˜ ë°œìƒ: ${e.getMessage()}"
                }
            }
        }
    }
}