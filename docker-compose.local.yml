version: '3.8'

services:
  # Backend API Server
  backend:
    build:
      context: ./base_server
      dockerfile: Dockerfile
    image: ashone91/trading-backend:local
    container_name: trading-backend-test
    ports:
      - "8000:8000"
    environment:
      - APP_ENV=LOCAL
      - PYTHONUNBUFFERED=1
    volumes:
      # Backend ì„¤ì • íŒŒì¼ ë§ˆìš´íŒ… (01 ë¬¸ì„œ ë°©ì‹)
      - "C:/SKN12-FINAL-2TEAM/base_server/application/base_web_server/base_web_server-config_local.json:/app/application/base_web_server/base_web_server-config_local.json:ro"
      # ë¡œê·¸ ë””ë ‰í† ë¦¬ ë§ˆìš´íŒ…
      - "C:/docker-logs:/app/logs"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - trading-network

  # Frontend Next.js Server
  frontend:
    build:
      context: ./base_server/frontend/ai-trading-platform
      dockerfile: Dockerfile
    image: ashone91/trading-frontend:local
    container_name: trading-frontend-test
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    volumes:
      # Frontend ì„¤ì • íŒŒì¼ ë§ˆìš´íŒ… (Backend ë°©ì‹ ë”°ë¼í•¨)
      - "C:/docker-frontend-configs/.env:/app/.env:ro"
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - trading-network

networks:
  trading-network:
    driver: bridge

# =============================================================================
# ğŸš€ ì‚¬ìš©ë²• (Windows ë¡œì»¬ í…ŒìŠ¤íŠ¸)
# =============================================================================
#
# 1ï¸âƒ£ ì„¤ì • íŒŒì¼ ì¤€ë¹„:
#    mkdir C:\docker-logs -Force
#    mkdir C:\docker-frontend-configs -Force
#    
#    # Frontend ì„¤ì • íŒŒì¼ ìƒì„±
#    echo "NEXT_PUBLIC_API_URL=http://backend:8000" > C:\docker-frontend-configs\.env
#    echo "NEXT_PUBLIC_WS_URL=ws://backend:8000" >> C:\docker-frontend-configs\.env
#    echo "BACKEND_URL=http://backend:8000" >> C:\docker-frontend-configs\.env
#
# 2ï¸âƒ£ ì‹¤í–‰:
#    docker-compose -f docker-compose.local.yml up -d
#
# 3ï¸âƒ£ í™•ì¸:
#    http://localhost:8000  # Backend API
#    http://localhost:3000  # Frontend UI
#
# 4ï¸âƒ£ ë¡œê·¸ í™•ì¸:
#    docker-compose -f docker-compose.local.yml logs -f
#
# 5ï¸âƒ£ ì •ë¦¬:
#    docker-compose -f docker-compose.local.yml down
#
# =============================================================================