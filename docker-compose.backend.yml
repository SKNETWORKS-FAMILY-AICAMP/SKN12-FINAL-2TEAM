version: '3.8'

services:
  backend:
    image: ashone91/trading-backend:latest
    container_name: trading-backend-prod
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - APP_ENV=PROD
      - PYTHONUNBUFFERED=1
    volumes:
      # ì„¤ì • íŒŒì¼ ë³¼ë¥¨ ë§ˆìš´íŒ… (ë¡œì»¬ í…ŒìŠ¤íŠ¸ ë°©ì‹ê³¼ ë™ì¼)
      - "/opt/trading/configs/base_web_server-config.json:/app/application/base_web_server/base_web_server-config.json:ro"
      # ë¡œê·¸ ë””ë ‰í† ë¦¬ ë§ˆìš´íŒ…
      - "/opt/trading/logs:/app/logs"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - trading-backend-network

networks:
  trading-backend-network:
    driver: bridge

# =============================================================================
# ðŸš€ Backend ì„œë¹„ìŠ¤ ì‚¬ìš©ë²• (AWS EC2)
# =============================================================================
#
# 1ï¸âƒ£ ì„¤ì • íŒŒì¼ ì¤€ë¹„:
#    sudo mkdir -p /opt/trading/configs
#    sudo mkdir -p /opt/trading/logs
#    sudo chown -R ubuntu:ubuntu /opt/trading
#    
#    # Backend ì„¤ì • íŒŒì¼ ìƒì„± (PROD í™˜ê²½)
#    sudo tee /opt/trading/configs/base_web_server-config.json > /dev/null << 'EOF'
#    {
#      "templateConfig": {
#        "appId": "finance_app",
#        "env": "PROD",
#        "skipAwsTests": true
#      },
#      "databaseConfig": {
#        "type": "mysql",
#        "host": "trading-mysql-db.cpkmaq4eqdte.ap-northeast-2.rds.amazonaws.com",
#        "port": 3306,
#        "user": "trading",
#        "password": "dkdlqmsbwlstmdptmvkWkd1234!",
#        "database": "finance_global",
#        "shard_databases": ["finance_shard_1", "finance_shard_2"]
#      },
#      "cacheConfig": {
#        "type": "redis",
#        "host": "ec2-52-78-194-14.ap-northeast-2.compute.amazonaws.com",
#        "port": 6379,
#        "password": "dkdlqmsbwlstmdptmvkWkd1234!",
#        "session_expire_seconds": 3600
#      },
#      "llmConfig": {
#        "default_provider": "openai",
#        "providers": {
#          "openai": {
#            "api_key": "sk-your-openai-api-key-here",
#            "model": "gpt-4",
#            "temperature": 0.7,
#            "max_tokens": 2000
#          }
#        }
#      },
#      "serverConfig": {
#        "host": "0.0.0.0",
#        "port": 8000,
#        "cors_origins": [
#          "https://bullant-kr.com",
#          "https://*.bullant-kr.com",
#          "http://localhost:3000"
#        ]
#      }
#    }
#    EOF
#
# 2ï¸âƒ£ Backend ì„œë¹„ìŠ¤ ì‹¤í–‰:
#    docker-compose -f docker-compose.backend.yml pull
#    docker-compose -f docker-compose.backend.yml up -d
#
# 3ï¸âƒ£ ìƒíƒœ í™•ì¸:
#    docker-compose -f docker-compose.backend.yml ps
#    docker-compose -f docker-compose.backend.yml logs -f backend
#
# 4ï¸âƒ£ í—¬ìŠ¤ì²´í¬:
#    curl http://localhost:8000/health
#
# 5ï¸âƒ£ ì„œë¹„ìŠ¤ ì¤‘ì§€:
#    docker-compose -f docker-compose.backend.yml down
#
# =============================================================================