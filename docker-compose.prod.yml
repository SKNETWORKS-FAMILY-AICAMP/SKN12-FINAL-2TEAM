version: '3.8'

services:
  # Backend API Server
  backend:
    image: ${DOCKER_IMAGE_BACKEND:-ashone91/trading-backend}:${TAG:-latest}
    container_name: trading-backend-prod
    ports:
      - "8000:8000"
    environment:
      - APP_ENV=PROD
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=Info
    volumes:
      # ì„¤ì • íŒŒì¼ì€ í˜¸ìŠ¤íŠ¸ì—ì„œ ë¯¸ë¦¬ ì¤€ë¹„
      - /opt/trading/configs/base_web_server-config.json:/app/application/base_web_server/base_web_server-config.json:ro
      - /opt/trading/logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - trading-network
    depends_on:
      - redis
      - mysql

  # Frontend Next.js Server
  frontend:
    image: ${DOCKER_IMAGE_FRONTEND:-ashone91/trading-frontend}:${TAG:-latest}
    container_name: trading-frontend-prod
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://backend:8000
      - NEXT_PUBLIC_WS_URL=ws://backend:8000
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    depends_on:
      - backend
    networks:
      - trading-network

  # Redis Cache (ë¡œì»¬ ì»¨í…Œì´ë„ˆ - EC2 Redis ì‚¬ìš©ì‹œ ì œê±°)
  redis:
    image: redis:7-alpine
    container_name: trading-redis-prod
    ports:
      - "6379:6379"
    command: redis-server --requirepass YOUR_REDIS_PASSWORD
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped
    networks:
      - trading-network

  # MySQL Database (ë¡œì»¬ ì»¨í…Œì´ë„ˆ - RDS ì‚¬ìš©ì‹œ ì œê±°)
  mysql:
    image: mysql:8.0
    container_name: trading-mysql-prod
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=YOUR_DB_PASSWORD
      - MYSQL_DATABASE=finance_global
      - MYSQL_USER=YOUR_DB_USERNAME
      - MYSQL_PASSWORD=YOUR_DB_PASSWORD
    volumes:
      - mysql-data:/var/lib/mysql
      - /opt/trading/db_scripts:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-pYOUR_DB_PASSWORD"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - trading-network

networks:
  trading-network:
    driver: bridge

volumes:
  redis-data:
  mysql-data:

# =============================================================================
# ğŸš€ í”„ë¡œë•ì…˜ ë°°í¬ ì‚¬ìš©ë²•
# =============================================================================
#
# 1ï¸âƒ£ ì„¤ì • íŒŒì¼ ì¤€ë¹„ (EC2ì—ì„œ):
#    sudo mkdir -p /opt/trading/configs
#    sudo mkdir -p /opt/trading/logs
#    sudo mkdir -p /opt/trading/db_scripts
#
#    # Backend ì„¤ì • íŒŒì¼ ìƒì„± (RDS/Redis EC2 ì‚¬ìš©ì‹œ)
#    sudo vi /opt/trading/configs/base_web_server-config.json
#    {
#      "templateConfig": {
#        "appId": "finance_app",
#        "env": "PROD",
#        "skipAwsTests": true
#      },
#      "databaseConfig": {
#        "type": "mysql",
#        "host": "trading-mysql-db.xxxx.rds.amazonaws.com",  # RDS ì—”ë“œí¬ì¸íŠ¸
#        "port": 3306,
#        "user": "trading",
#        "password": "YOUR_PASSWORD",
#        "database": "finance_global",
#        "shard_databases": ["finance_shard_1", "finance_shard_2"]
#      },
#      "cacheConfig": {
#        "type": "redis",
#        "host": "10.0.x.x",  # Redis EC2 Private IP
#        "port": 6379,
#        "password": "YOUR_PASSWORD",
#        "session_expire_seconds": 3600
#      }
#    }
#
# 2ï¸âƒ£ Docker Compose ì‹¤í–‰:
#    # ì „ì²´ ìŠ¤íƒ ì‹¤í–‰ (ë¡œì»¬ DB/Redis í¬í•¨)
#    docker-compose -f docker-compose.prod.yml up -d
#
#    # ë˜ëŠ” ì™¸ë¶€ DB/Redis ì‚¬ìš©ì‹œ (backend/frontendë§Œ)
#    docker-compose -f docker-compose.prod.yml up -d backend frontend
#
# 3ï¸âƒ£ ìƒíƒœ í™•ì¸:
#    docker-compose -f docker-compose.prod.yml ps
#    docker-compose -f docker-compose.prod.yml logs -f
#
# 4ï¸âƒ£ ì„œë¹„ìŠ¤ ì ‘ì†:
#    http://ì„œë²„IP:3000  # Frontend
#    http://ì„œë²„IP:8000  # Backend API
#
# 5ï¸âƒ£ ì—…ë°ì´íŠ¸ (Rolling Update):
#    export TAG=v1.0.1  # ìƒˆ ë²„ì „ íƒœê·¸
#    docker-compose -f docker-compose.prod.yml pull
#    docker-compose -f docker-compose.prod.yml up -d --no-deps backend
#    docker-compose -f docker-compose.prod.yml up -d --no-deps frontend
#
# 6ï¸âƒ£ ì •ë¦¬:
#    docker-compose -f docker-compose.prod.yml down
#    docker-compose -f docker-compose.prod.yml down -v  # ë³¼ë¥¨ í¬í•¨ ì‚­ì œ
#
# =============================================================================
# ğŸ”§ í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (.env íŒŒì¼)
# =============================================================================
# DOCKER_IMAGE_BACKEND=ashone91/trading-backend
# DOCKER_IMAGE_FRONTEND=ashone91/trading-frontend
# TAG=latest
# =============================================================================